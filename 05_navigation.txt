-- 3) Compute previous month and percentage change

WITH monthly AS (
  SELECT TRUNC(sale_date,'MM') AS month, SUM(amount) AS month_total
  FROM transactions
  GROUP BY TRUNC(sale_date,'MM')
)
SELECT month,
       month_total,
       LAG(month_total) OVER (ORDER BY month) AS prev_month_total,
       CASE
         WHEN LAG(month_total) OVER (ORDER BY month) IS NULL THEN NULL
         WHEN LAG(month_total) OVER (ORDER BY month) = 0 THEN NULL
         ELSE ROUND((month_total - LAG(month_total) OVER (ORDER BY month)) / LAG(month_total) OVER (ORDER BY month) * 100, 2)
       END AS mom_percent_change
FROM monthly
ORDER BY month;
